name: Test Self-Hosted Runner
on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-runner.yml'

jobs:
  test-runner:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      
      - name: 🏃 Runner Information
        run: |
          echo "✅ Running on self-hosted runner!"
          echo "Runner name: ${RUNNER_NAME:-unknown}"
          echo "Runner OS: ${RUNNER_OS:-Linux}"
          echo "Runner Arch: ${RUNNER_ARCH:-X64}"
          echo "Working Directory: $(pwd)"
          
      - name: 🐳 Test Docker Access
        run: |
          echo "Docker version:"
          docker --version
          echo ""
          echo "Docker info:"
          docker info | grep -E "(Server Version|Operating System|Architecture)"
          
      - name: 🔨 Test Container Build
        run: |
          # Create test Dockerfile
          cat > Dockerfile.test << 'EOF'
          FROM alpine:latest
          RUN echo "Hello from self-hosted runner build test"
          CMD ["echo", "Container test successful!"]
          EOF
          
          # Build and run test container
          docker build -f Dockerfile.test -t test-runner-image .
          docker run --rm test-runner-image
          
          # Cleanup
          docker rmi test-runner-image
          rm Dockerfile.test
          
      - name: 📊 Performance Test
        run: |
          echo "Testing runner performance..."
          START=$(date +%s)
          
          # Simulate some work
          for i in {1..5}; do
            echo "Task $i/5"
            sleep 1
          done
          
          END=$(date +%s)
          DURATION=$((END - START))
          echo "✅ Performance test completed in ${DURATION} seconds"
          
      - name: 🎉 Summary
        run: |
          echo "## Test Summary"
          echo "All tests passed! Your self-hosted runner is working correctly."
          echo ""
          echo "### What's working:"
          echo "- ✅ Runner registration and job pickup"
          echo "- ✅ Docker access from runner"
          echo "- ✅ Container building capability"
          echo "- ✅ GitHub Actions checkout"
          echo ""
          echo "### Next steps:"
          echo "1. Use 'runs-on: self-hosted' in your workflows"
          echo "2. Save GitHub Actions minutes!"
          echo "3. Scale with: docker-compose up -d --scale runner=3"